<div class="pl-6 pb-3 relative">
  <div class="absolute left-3 top-0 bottom-4 w-px bg-slate-200 dark:bg-slate-700" [ngClass]="getDynamicBorder()"></div>

  @for (step of workflowData; track $index) {
  <div>
    <ng-container *ngTemplateOutlet="logicFlowEditor; context:{node:step}"></ng-container>
  </div>
  }

  <button
    class="mt-3 text-[11px] font-bold text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 flex items-center gap-1"
    (click)="openStepOption(workflowData[0])">
    <i class="fas fa-plus-circle"></i> Add Step
  </button>

  @if (isAddStepOpen[workflowData[0].step_id]) {
  <ng-component *ngTemplateOutlet="stepOptionTemplate; context:{node:workflowData[0]}"></ng-component>
  }
</div>

<ng-template #logicFlowEditor let-node="node" let-parentVar="parentVar">
  @if (node.type == 'start') {
  <div cdkDropList [cdkDropListData]="node.children" (cdkDropListDropped)="drop($event)">
    <div class="relative mt-3 pr-3">
      <div class="absolute -left-3 top-5 w-3 h-px bg-slate-200 dark:bg-slate-700"></div>

      <div
        class="flex items-center gap-3 p-2 bg-slate-50/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 dark:hover:border-indigo-500 transition-colors">
        <i class="fas fa-play text-slate-400 dark:text-slate-500 text-xs"></i>
        <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">Start Workflow</span>
      </div>
    </div>
    @for (item of node.children; track $index) {
    <div cdkDrag [cdkDragData]="item">
      <ng-component *ngTemplateOutlet="logicFlowEditor; context:{node:item, parentVar:parentVar}"></ng-component>
    </div>
    }
  </div>

  } @else if (node.type == 'end') {
  <div class="relative mt-3 pr-3">
    <div class="absolute -left-3 top-5 w-3 h-px bg-slate-200 dark:bg-slate-700"></div>

    <div
      class="flex items-center gap-3 p-2 bg-slate-50/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 dark:hover:border-indigo-500 transition-colors">
      <i class="fas fa-flag-checkered text-slate-400 dark:text-slate-500 text-xs"></i>
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">End Workflow</span>
    </div>
  </div>
  } @else if(node.type == 'assignment') {
  <div class="relative mt-3 pr-3">
    <div class="absolute -left-3 top-5 w-3 h-px bg-slate-200 dark:bg-slate-700"></div>
    <div
      class="flex items-center gap-3 p-2 bg-slate-50/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 dark:hover:border-indigo-500 transition-colors">
      <i class="fas fa-equals text-slate-400 dark:text-slate-500 text-xs"></i>
      @if (node.statement_label) {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">{{node.statement_label}}</span>
      }@else {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">Assign value <b class="text-red-500">
          <i class="fas fa-exclamation-triangle text-yellow-600"></i>
          Yet to
          configure</b></span>
      }
      <div class="ml-auto flex gap-1">
        <button class="text-indigo-400 hover:text-slate-600 dark:text-indigo-500 dark:hover:text-indigo-300"
          (click)="openAssignmentConfig(node, parentVar)">
          <i class="fas fa-cog"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepUp(node)">
          <i class="fas fa-arrow-up"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepDown(node)">
          <i class="fas fa-arrow-down"></i>
        </button>
      </div>
    </div>
  </div>
  } @else if(node.type == 'condition') {
  <ng-component *ngTemplateOutlet="conditionTemplate; context:{node:node, parentVar:parentVar}"></ng-component>
  }
  @if (node.type == 'for_each') {
  <div class="relative mt-3 pr-3">
    <div class="absolute -left-3 top-5 w-3 h-px bg-slate-200 dark:bg-slate-700"></div>

    <div
      class="flex items-center gap-3 p-2 bg-slate-50/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 dark:hover:border-indigo-500 transition-colors">
      <i class="fas fa-sync-alt text-slate-400 dark:text-slate-500 text-xs"></i>
      @if (node.statement_label) {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">{{node.statement_label}}</span>
      }@else {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">For each <b class="text-red-500">
          <i class="fas fa-exclamation-triangle text-yellow-600"></i>
          Yet to
          configure</b></span>
      }
      <div class="ml-auto flex gap-1">
        <button class="text-indigo-400 hover:text-slate-600 dark:text-indigo-500 dark:hover:text-indigo-300"
          (click)="openLoopConfig(node, parentVar)">
          <i class="fas fa-cog"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepUp(node)">
          <i class="fas fa-arrow-up"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepDown(node)">
          <i class="fas fa-arrow-down"></i>
        </button>
      </div>
    </div>
    @for (item of node.children; track $index) {
    <div class="pl-6 border-l-2 dark:border-slate-700" [ngClass]="getDynamicBorder()">
      <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
      <div cdkDropList [cdkDropListData]="node.children" (cdkDropListDropped)="drop($event)">
        <ng-component *ngTemplateOutlet="logicFlowEditor; context:{node:item, parentVar:node.target}" cdkDrag
          [cdkDragData]="item"></ng-component>
      </div>
    </div>
    }
    @if (node.statement_label) {
    <div>
      <button
        class="mt-3 text-[11px] font-bold text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 flex items-center gap-1"
        (click)="openStepOption(node)">
        <i class="fas fa-plus-circle"></i> Add loop step
      </button>
      @if (isAddStepOpen[node.step_id]) {
      <ng-component *ngTemplateOutlet="stepOptionTemplate; context:{node:node}"></ng-component>
      }
    </div>
    }
  </div>
  }
</ng-template>

<ng-template #conditionTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3">
    <div class="absolute left-3 top-5 w-3 h-px bg-slate-200 dark:bg-slate-700"></div>

    <div
      class="flex items-center gap-3 p-2 bg-slate-50/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 transition-colors">
      <i class="fas fa-code-branch text-slate-400 dark:text-slate-500 text-xs"></i>
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">Check </span>
      @if (node.statement_label) {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">{{node.statement_label}}</span>
      }@else {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">if<b class="text-red-500">
          <i class="fas fa-exclamation-triangle text-yellow-600"></i>
          Yet to
          configure</b></span>
      }
      <div class="ml-auto">
        <button class="text-indigo-400 hover:text-slate-600 dark:text-indigo-500 dark:hover:text-indigo-300"
          (click)="openConditionConfig(node, parentVar)">
          <i class="fas fa-cog"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepUp(node)">
          <i class="fas fa-arrow-up"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepDown(node)">
          <i class="fas fa-arrow-down"></i>
        </button>
      </div>
    </div>

    <div class="pl-6 mt-3">
      <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
      <div
        class="flex items-center gap-3 p-2 bg-green-50/50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg hover:border-green-300 transition-colors">
        <i class="fas fa-check text-green-400 dark:text-green-500 text-xs"></i>
        <span class="text-sm text-green-700 dark:text-green-300 font-medium">If condition met</span>
      </div>
      @for (item of node.true_children; track $index) {
      <div class="pl-6 border-l-2 border-green-200 dark:border-green-900">
        <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
        <ng-component *ngTemplateOutlet="logicFlowEditor; context:{node:item, parentVar:parentVar}"></ng-component>
      </div>
      }
      <button
        class="mt-3 text-[11px] font-bold text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 flex items-center gap-1"
        (click)="openStepOption(node, '_true')">
        <i class="fas fa-plus-circle"></i> Add true branch step
      </button>
      @if (isAddStepOpen[node.step_id + '_true']) {
      <ng-component
        *ngTemplateOutlet="stepOptionTemplate; context:{node:node, isTrue:true, parentVar:parentVar}"></ng-component>
      }
    </div>

    <div class="pl-6 mt-3">
      <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
      <div
        class="flex items-center gap-3 p-2 bg-red-50/50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg hover:border-red-300 transition-colors">
        <i class="fas fa-times text-red-400 dark:text-red-500 text-xs"></i>
        <span class="text-sm text-red-700 dark:text-red-300 font-medium">If condition not met</span>
      </div>
      @for (item of node.false_children; track $index) {
      <div class="pl-6 border-l-2 border-red-200 dark:border-red-900">
        <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
        <ng-component *ngTemplateOutlet="logicFlowEditor; context:{node:item, parentVar:parentVar}"></ng-component>
      </div>
      }
      <button
        class="mt-3 text-[11px] font-bold text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 flex items-center gap-1"
        (click)="openStepOption(node, '_false')">
        <i class="fas fa-plus-circle"></i> Add false branch step
      </button>
      @if (isAddStepOpen[node.step_id + '_false']) {
      <ng-component
        *ngTemplateOutlet="stepOptionTemplate; context:{node:node, isFalse:true, parentVar:parentVar}"></ng-component>
      }
    </div>
  </div>
</ng-template>

<ng-template #stepOptionTemplate let-node="node" let-isTrue="isTrue" let-isFalse="isFalse">
  <div class="p-6">
    <!-- Header -->
    <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-5">
      Add New Step
    </h4>

    <!-- Simple List -->
    <div class="space-y-2">
      @for (option of stepOptions; track $index) {
      <div
        class="flex items-center gap-3 p-4 bg-white border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-indigo-400 hover:bg-indigo-50 dark:bg-gray-800 dark:border-gray-700 dark:hover:border-indigo-500 dark:hover:bg-gray-750"
        (click)="addStep(node, option, isTrue, isFalse, isTrue ? '_true' : isFalse ? '_false' : '');">

        <!-- Icon -->
        <div class="w-10 h-10 rounded-lg bg-indigo-600 flex items-center justify-center flex-shrink-0">
          <i class="{{ option.icon }} text-white"></i>
        </div>

        <!-- Label -->
        <span class="text-sm font-medium text-gray-900 dark:text-white">
          {{ option.label }}
        </span>
      </div>
      }
    </div>
  </div>
</ng-template>


@if (isConfigPanOpen) {
<app-side-draw [isOpen]="isConfigPanOpen" [title]="configDrawTitle" className="w-full w-80 min-w-[40%] md:w-96"
  (close)="closeConditionConfig()">
  @switch (configType) {
  @case ('condition') {
  <app-condition-configure [conditionNode]="selectedNodeForConfig" [parentVar]="parentVar"
    [variables]="variablePackage.variables" (onCancel)="closeConditionConfig()" (onSave)="saveConditionConfig($event)"
    (onDelete)="deleteConfig($event)"></app-condition-configure>
  }
  @case ('for_each') {
  <app-loop-configure [loopNode]="selectedNodeForConfig" [parentVar]="parentVar" [variables]="variablePackage.variables"
    (onCancel)="closeLoopConfig()" (onSave)="saveLoopConfig($event)"
    (onDelete)="deleteConfig($event)"></app-loop-configure>
  }
  @case ('assignment') {
  <app-assignment-configure [assignmentNode]="selectedNodeForConfig" [parentVar]="parentVar"
    [variables]="variablePackage.variables" (onCancel)="closeAssignmentConfig()" (onSave)="saveAssignmentConfig($event)"
    (onDelete)="deleteConfig($event)"></app-assignment-configure>
  }
  }
</app-side-draw>
}