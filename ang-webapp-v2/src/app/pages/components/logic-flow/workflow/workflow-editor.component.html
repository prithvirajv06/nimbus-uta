<div class="pl-6 pb-3 relative">
  <div class="absolute left-3 top-0 bottom-4 w-px bg-slate-200 dark:bg-slate-700" [ngClass]="getDynamicBorder()"></div>

  @for (step of workflowData; track $index) {
  <div>
    <ng-container *ngTemplateOutlet="logicFlowEditor; context:{node:step}"></ng-container>
  </div>
  }
</div>

<ng-template #logicFlowEditor let-node="node" let-parentVar="parentVar">
  @if (node.type == 'start') {
  <ng-component *ngTemplateOutlet="startTemplate; context:{node:node, parentVar:parentVar}"></ng-component>
  } @else if(node.type == 'assignment') {
  <ng-component *ngTemplateOutlet="assignmentTemplate; context:{node:node, parentVar:parentVar}"></ng-component>
  } @else if(node.type == 'condition') {
  <ng-component *ngTemplateOutlet="conditionTemplate; context:{node:node, parentVar:parentVar}"></ng-component>
  }
  @else if (node.type == 'for_each') {
  <ng-container *ngTemplateOutlet="loopTemplate; context:{node:node, parentVar:parentVar}"></ng-container>
  }
  @else if(node.type == 'push_array') {
  <ng-container *ngTemplateOutlet="pushArrayTemplate; context:{node:node, parentVar:parentVar}"></ng-container>
  }
  @else if(node.type == 'to_uppercase') {
  <ng-container *ngTemplateOutlet="toUppercaseTemplate; context:{node:node, parentVar:parentVar}"></ng-container>
  }
  @else if(node.type == 'increment') {
  <ng-container *ngTemplateOutlet="incrementTemplate; context:{node:node, parentVar:parentVar}"></ng-container>
  }
  @else if(node.type == 'decrement') {
  <ng-container *ngTemplateOutlet="decrementTemplate; context:{node:node, parentVar:parentVar}"></ng-container>
  }
  @else if(node.type == 'append_prefix') {
  <ng-container *ngTemplateOutlet="appendPrefixTemplate; context:{node:node, parentVar:parentVar}"></ng-container>
  }
  @else if(node.type == 'append_suffix') {
  <ng-container *ngTemplateOutlet="appendSuffixTemplate; context:{node:node, parentVar:parentVar}"></ng-container>
  }
  @else if(node.type == 'multiply') {
  <ng-container *ngTemplateOutlet="multiplyTemplate; context:{node:node, parentVar:parentVar}"></ng-container>
  }
  @else if(node.type == 'divide') {
  <ng-container *ngTemplateOutlet="divideTemplate; context:{node:node, parentVar:parentVar}"></ng-container>
  }
  @else if(node.type == 'network_call') {
  <ng-container *ngTemplateOutlet="networkCallTemplate; context:{node:node, parentVar:parentVar}"></ng-container>
  }
  @if (isAddStepOpen[node.step_id] && node.type != 'condition') {
  <ng-component *ngTemplateOutlet="stepOptionTemplate; context:{node:node, isTrue:false, isFalse:false}"></ng-component>
  }
</ng-template>


<ng-template let-node="node" let-parentVar="parentVar" #startTemplate>
  <div>
    <div class="relative mt-3 pr-3">
      <div class="absolute -left-3 top-5 w-3 h-px bg-slate-200 dark:bg-slate-700"></div>

      <div
        class="flex items-center gap-3 p-2 bg-slate-50/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 dark:hover:border-indigo-500 transition-colors">
        <i class="fas fa-play text-slate-400 dark:text-slate-500 text-xs"></i>
        <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">Start Workflow</span>
        <button
          class="text-[17px] font-bold text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 flex items-center gap-1"
          (click)="openStepOption(workflowData[0])">
          <i class="fas fa-plus-circle"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="isNodeColapsed[node.step_id] = !isNodeColapsed[node.step_id]">
          <i class="fas"
            [ngClass]="{'fa-chevron-up': !isNodeColapsed[node.step_id], 'fa-chevron-down': isNodeColapsed[node.step_id]}"></i>
        </button>
      </div>

    </div>
    @if (!isNodeColapsed[node.step_id]) {
    @for (item of node.children; track $index) {
    <div>
      <ng-component *ngTemplateOutlet="logicFlowEditor; context:{node:item, parentVar:parentVar}"></ng-component>
    </div>
    }
    }
  </div>
</ng-template>

<ng-template #loopTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3" [ngClass]="getNodeBgClass(node)">
    <div class="absolute -left-3 top-5 w-3 h-px bg-slate-200 dark:bg-slate-700"></div>

    <div
      class="flex items-center gap-3 p-2 bg-slate-50/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 dark:hover:border-indigo-500 transition-colors">
      <i class="fas fa-sync-alt text-slate-400 dark:text-slate-500 text-xs"></i>
      @if (node.statement_label) {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">{{node.statement_label}}</span>
      <button
        class="text-[17px] font-bold text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 flex items-center gap-1"
        (click)="openStepOption(node)">
        <i class="fas fa-plus-circle"></i>
      </button>
      <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
        (click)="isNodeColapsed[node.step_id] = !isNodeColapsed[node.step_id]">
        <i class="fas"
          [ngClass]="{'fa-chevron-up': !isNodeColapsed[node.step_id], 'fa-chevron-down': isNodeColapsed[node.step_id]}"></i>
      </button>
      }@else {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">For each <b class="text-red-500">
          <i class="fas fa-exclamation-triangle text-yellow-600"></i>
          Yet to
          configure</b></span>
      }
      <div class="ml-auto flex gap-1">
        <button class="text-indigo-400 hover:text-slate-600 dark:text-indigo-500 dark:hover:text-indigo-300"
          (click)="openLoopConfig(node, parentVar)">
          <i class="fas fa-cog"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepUp(node)">
          <i class="fas fa-arrow-up"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepDown(node)">
          <i class="fas fa-arrow-down"></i>
        </button>
      </div>
    </div>
    @if (!isNodeColapsed[node.step_id]) {
    @for (item of node.children; track $index) {
    <div class="pl-6" [ngClass]="getDynamicBorder()">
      <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
      <div>
        <ng-component *ngTemplateOutlet="logicFlowEditor; context:{node:item, parentVar:node.target}" cdkDrag
          [cdkDragData]="item"></ng-component>
      </div>
    </div>
    }
    }
  </div>
</ng-template>

<ng-template #assignmentTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3" [ngClass]="getNodeBgClass(node)">
    <div class="absolute left-3 top-5 w-3 h-px bg-slate-200 dark:bg-slate-700"></div>

    <div
      class="flex items-center gap-3 p-2 bg-slate-50/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 transition-colors">
      <i class="fas fa-exchange-alt text-slate-400 dark:text-slate-500 text-xs"></i>
      @if (node.statement_label) {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">{{node.statement_label}}</span>
      }@else {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">Assign Value <b class="text-red-500">
          <i class="fas fa-exclamation-triangle text-yellow-600"></i>
          Yet to
          configure</b></span>
      }
      <div class="ml-auto">
        <button class="text-indigo-400 hover:text-slate-600 dark:text-indigo-500 dark:hover:text-indigo-300"
          (click)="openAssignmentConfig(node, parentVar)">
          <i class="fas fa-cog"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepUp(node)">
          <i class="fas fa-arrow-up"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepDown(node)">
          <i class="fas fa-arrow-down"></i>
        </button>
      </div>
    </div>
  </div>
</ng-template>


<ng-template #conditionTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3" [ngClass]="getNodeBgClass(node)">
    <div class="absolute left-3 top-5 w-3 h-px bg-slate-200 dark:bg-slate-700"></div>

    <div
      class="flex items-center gap-3 p-2 bg-slate-50/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 transition-colors">
      <i class="fas fa-code-branch text-slate-400 dark:text-slate-500 text-xs"></i>
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">Check </span>
      @if (node.statement_label) {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">{{node.statement_label}}</span>
      }@else {
      <span class="text-sm text-slate-700 dark:text-slate-200 font-medium">if<b class="text-red-500">
          <i class="fas fa-exclamation-triangle text-yellow-600"></i>
          Yet to
          configure</b></span>
      }
      <div class="ml-auto">
        <button class="text-indigo-400 hover:text-slate-600 dark:text-indigo-500 dark:hover:text-indigo-300"
          (click)="openConditionConfig(node, parentVar)">
          <i class="fas fa-cog"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepUp(node)">
          <i class="fas fa-arrow-up"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="moveStepDown(node)">
          <i class="fas fa-arrow-down"></i>
        </button>
      </div>
    </div>

    <div class="pl-6 mt-3">
      <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
      <div
        class="flex items-center gap-3 p-2 bg-green-50/50 dark:bg-green-900/20 border border-green-500 dark:border-green-900 rounded-lg hover:border-green-600 transition-colors">
        <i class="fas fa-check text-green-400 dark:text-green-500 text-xs"></i>
        <span class="text-sm text-green-700 dark:text-green-300 font-medium">If condition met</span>
        <button
          class="text-[17px] font-bold text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 flex items-center gap-1"
          (click)="openStepOption(node, '_true')">
          <i class="fas fa-plus-circle"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="isNodeColapsed[node.step_id+'_true'] = !isNodeColapsed[node.step_id+'_true']">
          <i class="fas"
            [ngClass]="{'fa-chevron-up': !isNodeColapsed[node.step_id+'_true'], 'fa-chevron-down': isNodeColapsed[node.step_id+'_true']}"></i>
        </button>
      </div>
      @if (!isNodeColapsed[node.step_id+'_true']) {
      @for (item of node.true_children; track $index) {
      <div class="pl-6 border-l-2 border-green-500 dark:border-green-900">
        <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
        <ng-component *ngTemplateOutlet="logicFlowEditor; context:{node:item, parentVar:parentVar}"></ng-component>
      </div>
      }
      }
      @if (isAddStepOpen[node.step_id+'_true']) {
      <ng-component
        *ngTemplateOutlet="stepOptionTemplate; context:{node:node, isTrue:true, isFalse:false}"></ng-component>
      }
    </div>

    <div class="pl-6 mt-3">
      <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
      <div
        class="flex items-center gap-3 p-2 bg-red-50/50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg hover:border-red-300 transition-colors">
        <i class="fas fa-times text-red-400 dark:text-red-500 text-xs"></i>
        <span class="text-sm text-red-700 dark:text-red-300 font-medium">If condition not met</span>
        <button
          class="text-[17px] font-bold text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 flex items-center gap-1"
          (click)="openStepOption(node, '_false')">
          <i class="fas fa-plus-circle"></i>
        </button>
        <button class="text-slate-400 hover:text-indigo-500 dark:text-slate-500 dark:hover:text-indigo-400"
          (click)="isNodeColapsed[node.step_id+'_false'] = !isNodeColapsed[node.step_id+'_false']">
          <i class="fas"
            [ngClass]="{'fa-chevron-up': !isNodeColapsed[node.step_id+'_false'], 'fa-chevron-down': isNodeColapsed[node.step_id+'_false']}"></i>
        </button>
      </div>
      @if (!isNodeColapsed[node.step_id+'_false']) {
      @for (item of node.false_children; track $index) {
      <div class="pl-6 border-l-2 border-red-200 dark:border-red-900">
        <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
        <ng-component *ngTemplateOutlet="logicFlowEditor; context:{node:item, parentVar:parentVar}"></ng-component>
      </div>
      }
      }
    </div>
    @if (isAddStepOpen[node.step_id+'_false']) {
    <ng-component
      *ngTemplateOutlet="stepOptionTemplate; context:{node:node, isTrue:false, isFalse:true}"></ng-component>
    }
  </div>
</ng-template>



<ng-template #pushArrayTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3">
    <!-- Your UI for Push to Array step -->
    <div class="flex items-center gap-3 p-2 bg-slate-50/50 border border-slate-200 rounded-lg">
      <i class="fas fa-plus-square text-slate-400 text-xs"></i>
      <span class="text-sm text-slate-700 font-medium">Push to Array</span>
      <!-- Add config and move buttons as needed -->
    </div>
  </div>
</ng-template>

<ng-template #toUppercaseTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3">
    <div class="flex items-center gap-3 p-2 bg-slate-50/50 border border-slate-200 rounded-lg">
      <i class="fas fa-text-height text-slate-400 text-xs"></i>
      <span class="text-sm text-slate-700 font-medium">To Uppercase</span>
    </div>
  </div>
</ng-template>

<ng-template #incrementTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3">
    <div class="flex items-center gap-3 p-2 bg-slate-50/50 border border-slate-200 rounded-lg">
      <i class="fas fa-arrow-up text-slate-400 text-xs"></i>
      <span class="text-sm text-slate-700 font-medium">Increment</span>
    </div>
  </div>
</ng-template>

<ng-template #decrementTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3">
    <div class="flex items-center gap-3 p-2 bg-slate-50/50 border border-slate-200 rounded-lg">
      <i class="fas fa-arrow-down text-slate-400 text-xs"></i>
      <span class="text-sm text-slate-700 font-medium">Decrement</span>
    </div>
  </div>
</ng-template>

<ng-template #appendPrefixTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3">
    <div class="flex items-center gap-3 p-2 bg-slate-50/50 border border-slate-200 rounded-lg">
      <i class="fas fa-level-up-alt text-slate-400 text-xs"></i>
      <span class="text-sm text-slate-700 font-medium">Append Prefix</span>
    </div>
  </div>
</ng-template>

<ng-template #appendSuffixTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3">
    <div class="flex items-center gap-3 p-2 bg-slate-50/50 border border-slate-200 rounded-lg">
      <i class="fas fa-level-down-alt text-slate-400 text-xs"></i>
      <span class="text-sm text-slate-700 font-medium">Append Suffix</span>
    </div>
  </div>
</ng-template>

<ng-template #multiplyTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3">
    <div class="flex items-center gap-3 p-2 bg-slate-50/50 border border-slate-200 rounded-lg">
      <i class="fas fa-times text-slate-400 text-xs"></i>
      <span class="text-sm text-slate-700 font-medium">Multiply</span>
    </div>
  </div>
</ng-template>

<ng-template #divideTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3">
    <div class="flex items-center gap-3 p-2 bg-slate-50/50 border border-slate-200 rounded-lg">
      <i class="fas fa-divide text-slate-400 text-xs"></i>
      <span class="text-sm text-slate-700 font-medium">Divide</span>
    </div>
  </div>
</ng-template>

<ng-template #networkCallTemplate let-node="node" let-parentVar="parentVar">
  <div class="relative mt-3 pr-3">
    <div class="flex items-center gap-3 p-2 bg-slate-50/50 border border-slate-200 rounded-lg">
      <i class="fas fa-network-wired text-slate-400 text-xs"></i>
      <span class="text-sm text-slate-700 font-medium">Network Call</span>
    </div>
  </div>
</ng-template>

<ng-template #stepOptionTemplate let-node="node" let-isTrue="isTrue" let-isFalse="isFalse">
  <app-side-draw [isOpen]="true" [title]="'Add New Step'" className="w-full w-80 min-w-[40%] md:w-96"
    (close)="isAddStepOpen[node.step_id + (isTrue ? '_true' : isFalse ? '_false' : '')] = false">
    <div class="p-6">
      <!-- Simple List -->
      <div class="space-y-2">
        <input type="text" placeholder="Search step types..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
          [(ngModel)]="stepSearchQuery" (input)="searchStep()" />
        @for (option of filteredStepOptions; track $index) {
        <div
          class="flex items-center gap-3 p-4 bg-white border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-indigo-400 hover:bg-indigo-50 dark:bg-gray-800 dark:border-gray-700 dark:hover:border-indigo-500 dark:hover:bg-gray-750"
          (click)="addStep(node, option, isTrue, isFalse, isTrue ? '_true' : isFalse ? '_false' : '');">

          <!-- Icon -->
          <div class="w-10 h-10 rounded-lg bg-indigo-600 flex items-center justify-center flex-shrink-0">
            <i class="{{ option.icon }} text-white"></i>
          </div>

          <!-- Label -->
          <span class="text-sm font-medium text-gray-900 dark:text-white">
            {{ option.label }}
          </span>
        </div>
        }
      </div>
    </div>
  </app-side-draw>
</ng-template>



@if (isConfigPanOpen) {
<app-side-draw [isOpen]="isConfigPanOpen" [title]="configDrawTitle" className="w-full w-80 min-w-[40%] md:w-96"
  (close)="closeConditionConfig()">
  <span class="text-sm text-slate-500 dark:text-slate-400">
    Show Expression <i class="fas fa-code text-xs ml-1"></i>
  </span>
  @switch (configType) {
  @case ('condition') {
  <app-condition-configure [conditionNode]="selectedNodeForConfig" [parentVar]="parentVar"
    [variables]="variablePackage.variables" (onCancel)="closeConditionConfig()" (onSave)="saveConditionConfig($event)"
    (onDelete)="deleteConfig($event)"></app-condition-configure>
  }
  @case ('for_each') {
  <app-loop-configure [loopNode]="selectedNodeForConfig" [parentVar]="parentVar" [variables]="variablePackage.variables"
    (onCancel)="closeLoopConfig()" (onSave)="saveLoopConfig($event)"
    (onDelete)="deleteConfig($event)"></app-loop-configure>
  }
  @case ('assignment') {
  <app-assignment-configure [assignmentNode]="selectedNodeForConfig" [parentVar]="parentVar"
    [variables]="variablePackage.variables" (onCancel)="closeAssignmentConfig()" (onSave)="saveAssignmentConfig($event)"
    (onDelete)="deleteConfig($event)"></app-assignment-configure>
  }
  }
</app-side-draw>
}