@if (isSelectBox) {
<div class="relative w-full" id="variable-selector-dropdown">
    <!-- Main Select Input -->
    <input type="text"
        class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm placeholder-gray-400 focus:border-brand-400 focus:outline-none focus:ring-3 focus:ring-brand-500/20 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-500 dark:focus:border-brand-500 dark:focus:bg-gray-800"
        [placeholder]="selectedVariable ? selectedVariable.label : 'Select Variable'"
        [value]="selectedVariable ? selectedVariable.label : ''" readonly
        (click)="isVariableFilterOpen = true; filteredVars = variables; $event.stopPropagation()"
        (input)="filterSelection($event)" />
    <!-- Dropdown Icon -->
    <div class="absolute top-0 right-0 mt-3.5 mr-4 pointer-events-none text-gray-500 dark:text-gray-400">
        <i class="fa fa-caret-down text-lg"></i>
    </div>


    <!-- Dropdown Menu -->
    @if (isVariableFilterOpen) {
    <div class="absolute z-50 mt-2 min-w-[600px] max-h-160 rounded-xl bg-white shadow-xl border border-gray-100 dark:border-gray-700 dark:bg-gray-800"
        appClickOutside (clickOutside)="isVariableFilterOpen = false">

        <!-- Search Header -->
        <div class="p-4 border-b border-gray-100 dark:border-gray-700">
            <div class="relative">
                <i class="fa fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                <input type="text" placeholder="Search variables..."
                    class="w-[90%] rounded-lg border border-gray-200 bg-gray-50 pl-10 pr-10 py-2.5 text-sm transition-colors placeholder-gray-400 focus:border-brand-400 focus:bg-white focus:outline-none focus:ring-3 focus:ring-brand-500/20 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-500 dark:focus:border-brand-500 dark:focus:bg-gray-800"
                    (input)="filterSelection($event)" />
                <i class="fa fa-times absolute right-3.5 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 cursor-pointer transition-colors"
                    (click)="isVariableFilterOpen = false; $event.stopPropagation()"></i>
            </div>
        </div>

        <!-- Variables List -->
        <div class="max-h-96 overflow-y-auto py-2 custom-scrollbar">
            <ng-template #recursiveList let-vars>
                @for (_var of vars; track $index) {
                <div role="button"
                    (click)="_var.children && _var.children.length > 0 ? (openChild[_var.var_key]=!openChild[_var.var_key]) : null; $event.stopPropagation()"
                    class="group cursor-pointer select-none relative flex items-center mx-2 px-4 py-3 rounded-lg transition-all duration-150"
                    [ngClass]="isSelected(_var) ? 'bg-blue-600 text-white shadow-sm dark:bg-blue-600' : 'text-gray-700 hover:bg-blue-50 dark:text-gray-200 dark:hover:bg-gray-700'">
                    <div class="flex items-center w-full gap-2">


                        <!-- Required Indicator -->
                        @if (_var.is_required) {
                        <span class="mr-2 text-red-500 text-[10px]">
                            <i class="fa-solid fa-asterisk"></i>
                        </span>
                        }
                        <!-- Variable Type Icon -->
                        <i [ngClass]="getVarTypeIcon(_var)"
                            class="mr-3 text-orange-500 transition-colors dark:text-pink-400"
                            [class.text-gray-400]="!isSelected(_var)" [class.dark:text-gray-500]="!isSelected(_var)"
                            [class.text-white]="isSelected(_var)"></i>

                        <!-- Variable Label -->
                        <span class="" (click)="_var.isClickable ? setSelectVariable(_var) : null"
                            [ngClass]="_var.isClickable ? 'underline' : 'opacity-50 cursor-not-allowed hover:bg-transparent dark:hover:bg-transparent'">
                            {{ _var.label }}</span>
                        <!-- Expand Arrow for Children -->
                        @if (_var.children && _var.children.length > 0) {
                        <span class="ml-3 transition-transform duration-200 text-sm"
                            [ngClass]="openChild[_var.var_key] ? 'rotate-90' : ''">
                            <i class="fa fa-chevron-right"></i>
                        </span>
                        }

                        <!-- Selected Check Mark -->
                        @if (isSelected(_var) && !(_var.children && _var.children.length > 0)) {
                        <span class="ml-3">
                            <i class="fa fa-check text-sm"></i>
                        </span>
                        }
                    </div>
                </div>

                <!-- Nested Children -->
                @if (_var.children && _var.children.length > 0 && openChild[_var.var_key]) {
                <div class="ml-8 border-l-2 border-blue-100 dark:border-gray-600 pl-4 py-1">
                    <ng-container *ngTemplateOutlet="recursiveList; context: {$implicit: _var.children}"></ng-container>
                </div>
                }
                }
            </ng-template>

            <ng-container *ngTemplateOutlet="recursiveList; context: {$implicit: filteredVars}"></ng-container>

            <!-- Empty State -->
            @if (!filteredVars?.length) {
            <div class="text-center py-12">
                <i class="fa fa-search text-3xl text-gray-300 dark:text-gray-600 mb-3"></i>
                <p class="text-gray-400 dark:text-gray-500 text-sm">No variables found</p>
            </div>
            }
        </div>
    </div>
    }
</div>
}
@else {
<div class="flex gap-4">
    <!-- Main Variable List Card -->
    <div
        class="relative flex flex-col bg-white shadow-lg rounded-xl border border-gray-100 overflow-hidden dark:bg-gray-800 dark:border-gray-700 min-w-[280px]">

        <!-- Card Header -->
        <div
            class="flex gap-3 justify-between items-center px-5 py-4 bg-gradient-to-r from-gray-50 to-white border-b border-gray-200 dark:from-gray-800 dark:to-gray-800 dark:border-gray-700">
            <div class="font-semibold text-base text-gray-800 dark:text-white flex items-center gap-2">
                @if (selectedVariable) {
                <span>{{selectedVariable?.label}}</span>
                @if (selectedVariable?.children) {
                <i class="fa fa-chevron-right text-sm text-gray-400"></i>
                }
                } @else {
                <span class="text-gray-500 dark:text-gray-400">Select Variable</span>
                }
            </div>
        </div>

        <!-- Variable List -->
        <nav class="flex flex-col gap-1 p-3">
            @for (_var of variables; track $index) {
            <div role="button" (click)="setSelectVariable(_var)"
                class="flex items-center w-full px-4 py-3 rounded-lg transition-all duration-150 group cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-700"
                [ngClass]="isSelected(_var) ? 'bg-blue-600 text-white shadow-sm dark:bg-blue-600' : 'text-gray-700 dark:text-gray-200'">

                <!-- Required Indicator -->
                @if (_var.is_required) {
                <span class="text-red-500 text-[10px] mr-2">
                    <i class="fa-solid fa-asterisk"></i>
                </span>
                }

                <!-- Variable Type Icon -->
                <i [ngClass]="getVarTypeIcon(_var)" class="mr-3 text-base transition-colors"
                    [class.text-gray-400]="!isSelected(_var)" [class.dark:text-gray-500]="!isSelected(_var)"
                    [class.text-white]="isSelected(_var)"></i>

                <!-- Variable Label -->
                <span class="flex-1 font-medium">{{ _var.label }}</span>

                <!-- Children Count Badge -->
                @if (_var.children) {
                <div class="px-2.5 py-1 text-xs font-semibold rounded-full transition-colors"
                    [class.bg-white/20]="isSelected(_var)" [class.text-white]="isSelected(_var)"
                    [class.bg-gray-100]="!isSelected(_var)" [class.dark:bg-gray-700]="!isSelected(_var)"
                    [class.text-gray-600]="!isSelected(_var)" [class.dark:text-gray-300]="!isSelected(_var)">
                    {{_var.children.length}}
                </div>
                }
            </div>
            }
        </nav>
    </div>

    <!-- Filter Button (for arrays) -->
    @if (selectedVariable && selectedVariable.children) {
    @if (selectedVariable.type=='array') {
    <div class="flex justify-center items-center">
        <button (click)="isVariableFilterOpen = true"
            class="flex items-center justify-center w-14 h-14 text-gray-600 bg-white border-2 border-gray-200 rounded-xl shadow-sm transition-all duration-200 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 hover:shadow-md dark:bg-gray-800 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:border-blue-500 dark:hover:text-blue-400">
            <i class="fa fa-filter text-lg"></i>
        </button>
    </div>
    }

    <!-- Recursive Child Selector -->
    <div class="flex-1">
        <app-variable-selector [selectedVariablePath]="selectedVariablePath"
            (changeInFilter)="changeInFilter.emit($event)" (variableSelectedEvent)="variableSelectedEvent.emit($event)"
            [variables]="selectedVariable?.children">
        </app-variable-selector>
    </div>
    }
</div>

<!-- Filter Modal -->
<app-modal [isOpen]="isVariableFilterOpen" (close)="closeModal()"
    className="relative w-full m-5 sm:m-0 max-w-[580px] rounded-2xl bg-white shadow-2xl dark:bg-gray-800">
    <div class="p-8">

        <!-- Modal Header -->
        <div class="mb-6">
            <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">
                New Variable Filter
            </h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">
                Create a filter for <span
                    class="font-semibold text-gray-700 dark:text-gray-300">{{selectedVariable?.label}}</span>
            </p>
        </div>

        <!-- Form Fields -->
        <div class="space-y-5">

            <!-- Variable Selection -->
            <div>
                <app-label class="block mb-2 text-sm font-semibold text-gray-700 dark:text-gray-300">
                    Variable
                </app-label>
                <select
                    class="w-full appearance-none rounded-lg border-2 border-gray-200 bg-white px-4 py-3 text-sm font-medium transition-all focus:border-brand-400 focus:outline-none focus:ring-4 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-900 dark:text-white dark:focus:border-brand-500"
                    [field]="formGroup.var_key">
                    <option value="" disabled [selected]="!selectedFilterVariable"
                        class="text-gray-500 dark:bg-gray-900 dark:text-gray-400">
                        Select a variable...
                    </option>
                    @for (item of selectedVariable?.children; track $index) {
                    @if (item.type!='object' && item.type!='array') {
                    <option class="text-gray-700 dark:bg-gray-900 dark:text-gray-300" [value]="item.var_key">
                        {{ item.label }}
                    </option>
                    }
                    }
                </select>
            </div>

            <!-- Operator Selection -->
            <div>
                <app-label class="block mb-2 text-sm font-semibold text-gray-700 dark:text-gray-300">
                    Operator
                </app-label>
                <select
                    class="w-full appearance-none rounded-lg border-2 border-gray-200 bg-white px-4 py-3 text-sm font-medium transition-all focus:border-brand-400 focus:outline-none focus:ring-4 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-900 dark:text-white dark:focus:border-brand-500"
                    [field]="formGroup.operator">
                    <option value="" disabled [selected]="!selectedOperator"
                        class="text-gray-500 dark:bg-gray-900 dark:text-gray-400">
                        Select an operator...
                    </option>
                    @for (op of logicalOperators; track $index) {
                    <option class="text-gray-700 dark:bg-gray-900 dark:text-gray-300" [value]="op.value">
                        {{ op.label }}
                    </option>
                    }
                </select>
            </div>

            <!-- Value Input -->
            <div>
                <app-label class="block mb-2 text-sm font-semibold text-gray-700 dark:text-gray-300">
                    Value
                </app-label>
                <app-input-field type="text" placeholder="Enter filter value" [field]="formGroup.value"
                    class="w-full rounded-lg border-2 border-gray-200 bg-white px-4 py-3 text-sm transition-all focus:border-brand-400 focus:outline-none focus:ring-4 focus:ring-brand-500/20 dark:border-gray-700 dark:bg-gray-900 dark:text-white dark:focus:border-brand-500">
                </app-input-field>
            </div>
        </div>

        <!-- Modal Actions -->
        <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-gray-100 dark:border-gray-700">
            <button type="button"
                class="px-5 py-2.5 text-sm font-semibold text-gray-700 bg-white border-2 border-gray-200 rounded-lg transition-all hover:bg-gray-50 hover:border-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-700 dark:hover:bg-gray-700 dark:hover:border-gray-600"
                (click)="closeModal()">
                Cancel
            </button>
            <button type="submit" (click)="saveFilter()"
                class="px-5 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-lg shadow-sm transition-all hover:bg-blue-700 hover:shadow-md focus:outline-none focus:ring-4 focus:ring-blue-500/30 dark:bg-blue-600 dark:hover:bg-blue-700">
                Save Filter
            </button>
        </div>
    </div>
</app-modal>
}